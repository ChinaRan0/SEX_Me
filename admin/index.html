<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†åå°</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; min-height: 100vh; }
        .header { background: #1a1a2e; color: #fff; padding: 16px 24px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 20px; }
        .header-right { display: flex; align-items: center; gap: 16px; }
        .header-right span { font-size: 14px; opacity: 0.8; }
        .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; transition: all 0.3s; }
        .btn-logout { background: rgba(255,255,255,0.1); color: #fff; }
        .btn-logout:hover { background: rgba(255,255,255,0.2); }
        .container { display: flex; min-height: calc(100vh - 60px); }
        .sidebar { width: 200px; background: #fff; border-right: 1px solid #e0e0e0; padding: 16px 0; }
        .sidebar-item { padding: 12px 20px; cursor: pointer; color: #333; transition: all 0.2s; border-left: 3px solid transparent; font-size: 14px; }
        .sidebar-item:hover { background: #f5f5f5; }
        .sidebar-item.active { background: #f0f0f0; border-left-color: #1a1a2e; font-weight: 500; }
        .sidebar-section { padding: 12px 20px 6px; font-size: 12px; color: #999; font-weight: 500; text-transform: uppercase; }
        .main-content { flex: 1; padding: 24px; overflow-y: auto; }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .page-title { font-size: 24px; color: #1a1a2e; }
        .btn-primary { background: #1a1a2e; color: #fff; }
        .btn-primary:hover { background: #2d2d44; }
        .btn-secondary { background: #e0e0e0; color: #333; }
        .btn-danger { background: #dc3545; color: #fff; }
        .btn-success { background: #28a745; color: #fff; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .card { background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .card-header { padding: 16px 20px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; }
        .card-header h3 { font-size: 16px; }
        .table-container { overflow-x: auto; max-height: calc(100vh - 240px); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px 16px; text-align: left; border-bottom: 1px solid #e0e0e0; font-size: 14px; }
        th { background: #f5f5f5; font-weight: 600; color: #333; position: sticky; top: 0; }
        tr:hover { background: #fafafa; }
        .status-active { color: #28a745; }
        .status-inactive { color: #dc3545; }
        .actions { display: flex; gap: 8px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: #fff; border-radius: 12px; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
        .modal-content.wide { max-width: 900px; }
        .modal-header { padding: 20px 24px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { font-size: 18px; }
        .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #666; }
        .modal-body { padding: 24px; }
        .modal-footer { padding: 16px 24px; border-top: 1px solid #e0e0e0; display: flex; justify-content: flex-end; gap: 12px; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: #333; font-size: 14px; }
        .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: #1a1a2e; }
        .form-group textarea { min-height: 80px; resize: vertical; }
        .form-row { display: flex; gap: 16px; }
        .form-row .form-group { flex: 1; }
        .checkbox-group { display: flex; align-items: center; gap: 8px; }
        .checkbox-group input { width: auto; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .toast { position: fixed; top: 20px; right: 20px; padding: 16px 24px; border-radius: 8px; color: #fff; font-size: 14px; z-index: 2000; animation: slideIn 0.3s ease; }
        .toast.success { background: #28a745; }
        .toast.error { background: #dc3545; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .loading { text-align: center; padding: 40px; color: #666; }

        /* Preset cards */
        .preset-card { border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; margin-bottom: 12px; background: #fafafa; }
        .preset-card-header { display: flex; justify-content: space-between; align-items: center; }
        .preset-code { font-family: monospace; background: #1a1a2e; color: #fff; padding: 4px 12px; border-radius: 4px; font-size: 13px; }
        .share-urls { margin-top: 10px; }
        .share-url-item { background: #f0f0f0; padding: 8px 12px; border-radius: 6px; font-size: 13px; margin-bottom: 6px; display: flex; justify-content: space-between; align-items: center; }
        .share-url-item a { color: #1a1a2e; text-decoration: none; }
        .share-url-item a:hover { text-decoration: underline; }

        /* Round editor - åˆ†åˆ—å¸ƒå±€ */
        .round-columns { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 20px; }
        .round-column { background: #fafafa; border: 1px solid #e0e0e0; border-radius: 8px; padding: 16px; }
        .round-column.dice { border-top: 3px solid #1565c0; }
        .round-column.pose { border-top: 3px solid #c2185b; }
        .round-column.task { border-top: 3px solid #2e7d32; }
        .round-column.story { border-top: 3px solid #7b1fa2; }
        .column-title { font-weight: 600; font-size: 14px; margin-bottom: 12px; display: flex; align-items: center; gap: 6px; }
        .column-title.dice { color: #1565c0; }
        .column-title.pose { color: #c2185b; }
        .column-title.task { color: #2e7d32; }
        .column-title.story { color: #7b1fa2; }
        .round-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .round-row:last-child { margin-bottom: 0; }
        .round-label { min-width: 45px; font-size: 13px; color: #666; }
        .round-row select { flex: 1; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; min-width: 0; }
        .round-row.multi-select { flex-wrap: wrap; }
        .round-row.multi-select select { flex: 1 1 60px; min-width: 60px; max-width: 100px; }

        .empty-state { text-align: center; padding: 40px; color: #666; }
        .game-type-badge { display: inline-block; padding: 4px 10px; border-radius: 4px; font-size: 12px; margin-left: 8px; }
        .game-type-badge.dice { background: #e3f2fd; color: #1565c0; }
        .game-type-badge.pose { background: #fce4ec; color: #c2185b; }
        .game-type-badge.task { background: #e8f5e9; color: #2e7d32; }
        .game-type-badge.all { background: linear-gradient(135deg, #e3f2fd, #fce4ec, #e8f5e9); color: #1a1a2e; }

        /* å¯æœç´¢ä¸‹æ‹‰æ¡†æ ·å¼ */
        .searchable-select { position: relative; flex: 1; }
        .searchable-select input { width: 100%; cursor: pointer; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; }
        .searchable-select input:focus { outline: none; border-color: #1a1a2e; }
        .searchable-select-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .searchable-select-dropdown.show { display: block; }
        .searchable-select-option {
            padding: 8px 10px;
            cursor: pointer;
            font-size: 13px;
            border-bottom: 1px solid #eee;
        }
        .searchable-select-option:hover { background: #f5f5f5; }
        .searchable-select-option.selected { background: #e3f2fd; }
        .searchable-select-option.empty { color: #999; cursor: default; }
        .searchable-select-option.empty:hover { background: transparent; }
    </style>
</head>
<body>
    <div class="header">
        <h1>æ¸¸æˆæ•°æ®ç®¡ç†åå°</h1>
        <div class="header-right">
            <span id="currentUser">ç®¡ç†å‘˜</span>
            <button class="btn btn-logout" onclick="logout()">é€€å‡ºç™»å½•</button>
        </div>
    </div>

    <div class="container">
        <div class="sidebar">
            <div class="sidebar-section">é¢„è®¾ç®¡ç†</div>
            <div class="sidebar-item active" data-tab="presets">ç»Ÿä¸€é¢„è®¾</div>
            <div class="sidebar-section">æ•°æ®ç®¡ç†</div>
            <div class="sidebar-item" data-tab="dice-data">éª°å­æ•°æ®</div>
            <div class="sidebar-item" data-tab="pose-data">å§¿åŠ¿æ•°æ®</div>
            <div class="sidebar-item" data-tab="story-data">å‰§æƒ…æ•°æ®</div>
            <div class="sidebar-item" data-tab="task-data">ä»»åŠ¡åº“</div>
            <div class="sidebar-section">ç³»ç»Ÿè®¾ç½®</div>
            <div class="sidebar-item" data-tab="settings">ä¿®æ”¹å¯†ç </div>
        </div>

        <div class="main-content">
            <!-- ç»Ÿä¸€é¢„è®¾ -->
            <div id="presets-tab" class="tab-content active">
                <div class="page-header">
                    <h2 class="page-title">ç»Ÿä¸€é¢„è®¾ <span class="game-type-badge all">éª°å­+å§¿åŠ¿+ä»»åŠ¡</span></h2>
                    <button class="btn btn-primary" onclick="openPresetModal()">åˆ›å»ºé¢„è®¾</button>
                </div>
                <p style="color: #666; margin-bottom: 20px; font-size: 14px;">ä¸€ä¸ªé¢„è®¾åŒ…å«éª°å­ã€å§¿åŠ¿ã€ä»»åŠ¡ä¸‰ç§æ¸¸æˆçš„æ‰€æœ‰è½®æ¬¡æ•°æ®ï¼Œä¸‰ä¸ªæ¸¸æˆé¡µé¢å…±ç”¨åŒä¸€ä¸ªåˆ†äº«é“¾æ¥ã€‚</p>
                <div id="presetsList"></div>
            </div>

            <!-- éª°å­æ•°æ® -->
            <div id="dice-data-tab" class="tab-content">
                <div class="page-header"><h2 class="page-title">éª°å­æ•°æ®ç®¡ç†</h2></div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                    <div class="card">
                        <div class="card-header"><h3>åŠ¨ä½œåˆ—è¡¨</h3><button class="btn btn-primary btn-sm" onclick="openModal('action')">æ·»åŠ </button></div>
                        <div class="table-container" id="actionsTable"><div class="loading">åŠ è½½ä¸­...</div></div>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3>éƒ¨ä½åˆ—è¡¨</h3><button class="btn btn-primary btn-sm" onclick="openModal('part')">æ·»åŠ </button></div>
                        <div class="table-container" id="partsTable"><div class="loading">åŠ è½½ä¸­...</div></div>
                    </div>
                </div>
            </div>

            <!-- å§¿åŠ¿æ•°æ® -->
            <div id="pose-data-tab" class="tab-content">
                <div class="page-header"><h2 class="page-title">å§¿åŠ¿æ•°æ®ç®¡ç†</h2></div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                    <div class="card">
                        <div class="card-header"><h3>åœ°ç‚¹åˆ—è¡¨</h3><button class="btn btn-primary btn-sm" onclick="openModal('place')">æ·»åŠ </button></div>
                        <div class="table-container" id="placesTable"><div class="loading">åŠ è½½ä¸­...</div></div>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3>æ—¶é—´é€‰é¡¹</h3><button class="btn btn-primary btn-sm" onclick="openModal('time')">æ·»åŠ </button></div>
                        <div class="table-container" id="timesTable"><div class="loading">åŠ è½½ä¸­...</div></div>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3>å§¿åŠ¿æ•°é‡</h3><span id="poseCount">0</span></div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header"><h3>å§¿åŠ¿åˆ—è¡¨</h3><button class="btn btn-primary btn-sm" onclick="openModal('pose')">æ·»åŠ å§¿åŠ¿</button></div>
                    <div class="table-container" id="posesTable"><div class="loading">åŠ è½½ä¸­...</div></div>
                </div>
            </div>

            <!-- å‰§æƒ…æ•°æ® -->
            <div id="story-data-tab" class="tab-content">
                <div class="page-header"><h2 class="page-title">å‰§æƒ…æ•°æ®ç®¡ç†</h2></div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 24px;">
                    <div class="card">
                        <div class="card-header"><h3>ç”·æ–¹èº«ä»½</h3><button class="btn btn-primary btn-sm" onclick="openModal('story-male-roles')">æ·»åŠ </button></div>
                        <div class="table-container" id="maleRolesTable"><div class="loading">åŠ è½½ä¸­...</div></div>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3>å¥³æ–¹èº«ä»½</h3><button class="btn btn-primary btn-sm" onclick="openModal('story-female-roles')">æ·»åŠ </button></div>
                        <div class="table-container" id="femaleRolesTable"><div class="loading">åŠ è½½ä¸­...</div></div>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3>ä¸¤äººå…³ç³»</h3><button class="btn btn-primary btn-sm" onclick="openModal('story-relationships')">æ·»åŠ </button></div>
                        <div class="table-container" id="relationshipsTable"><div class="loading">åŠ è½½ä¸­...</div></div>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3>ä¸»åŠ¨æƒ</h3><button class="btn btn-primary btn-sm" onclick="openModal('story-initiatives')">æ·»åŠ </button></div>
                        <div class="table-container" id="initiativesTable"><div class="loading">åŠ è½½ä¸­...</div></div>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3>è¡Œä¸º</h3><button class="btn btn-primary btn-sm" onclick="openModal('story-behaviors')">æ·»åŠ </button></div>
                        <div class="table-container" id="behaviorsTable"><div class="loading">åŠ è½½ä¸­...</div></div>
                    </div>
                    <div class="card">
                        <div class="card-header"><h3>åŠ¨ä½œ</h3><button class="btn btn-primary btn-sm" onclick="openModal('story-actions')">æ·»åŠ </button></div>
                        <div class="table-container" id="storyActionsTable"><div class="loading">åŠ è½½ä¸­...</div></div>
                    </div>
                </div>
            </div>

            <!-- ä»»åŠ¡åº“ -->
            <div id="task-data-tab" class="tab-content">
                <div class="page-header">
                    <h2 class="page-title">éšæœºä»»åŠ¡åº“</h2>
                    <button class="btn btn-primary" onclick="openModal('task')">æ·»åŠ ä»»åŠ¡</button>
                </div>
                <div class="card">
                    <div class="table-container" id="tasksTable"><div class="loading">åŠ è½½ä¸­...</div></div>
                </div>
            </div>

            <!-- ç³»ç»Ÿè®¾ç½® -->
            <div id="settings-tab" class="tab-content">
                <div class="page-header"><h2 class="page-title">ä¿®æ”¹å¯†ç </h2></div>
                <div class="card" style="max-width: 500px;">
                    <div class="modal-body">
                        <form id="passwordForm" onsubmit="changePassword(event)">
                            <div class="form-group">
                                <label>å½“å‰å¯†ç </label>
                                <input type="password" id="oldPassword" required>
                            </div>
                            <div class="form-group">
                                <label>æ–°å¯†ç </label>
                                <input type="password" id="newPassword" required minlength="6">
                            </div>
                            <div class="form-group">
                                <label>ç¡®è®¤æ–°å¯†ç </label>
                                <input type="password" id="confirmPassword" required minlength="6">
                            </div>
                            <button type="submit" class="btn btn-primary">ä¿å­˜ä¿®æ”¹</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Simple Modal -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-header"><h3 id="modalTitle">æ·»åŠ </h3><button class="modal-close" onclick="closeModal()">&times;</button></div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveItem()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- Rounds Setup Modal -->
    <div class="modal" id="roundsSetupModal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header"><h3>åˆ›å»ºé¢„è®¾ - è®¾ç½®è½®æ•°</h3><button class="modal-close" onclick="closeRoundsSetupModal()">&times;</button></div>
            <div class="modal-body">
                <div class="form-group">
                    <label>æ¸¸æˆè½®æ•°</label>
                    <input type="number" id="setupRounds" value="5" min="1" max="20" style="text-align: center; font-size: 24px;">
                    <p style="color: #666; font-size: 12px; margin-top: 8px;">æ¯è½®åŒ…å«éª°å­ã€å§¿åŠ¿ã€ä»»åŠ¡ä¸‰ç§æ¸¸æˆçš„æ•°æ®</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeRoundsSetupModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="confirmRoundsSetup()">ç¡®å®šï¼Œå¼€å§‹ç¼–è¾‘</button>
            </div>
        </div>
    </div>

    <!-- Preset Modal -->
    <div class="modal" id="presetModal">
        <div class="modal-content wide" style="max-width: 1100px;">
            <div class="modal-header"><h3 id="presetModalTitle">ç¼–è¾‘é¢„è®¾</h3><button class="modal-close" onclick="closePresetModal()">&times;</button></div>
            <div class="modal-body" id="presetModalBody"></div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePresetModal()">å–æ¶ˆ</button>
                <button class="btn btn-success" onclick="generateRandomRounds()">è‡ªåŠ¨å¡«å……</button>
                <button class="btn btn-primary" onclick="savePreset()">ä¿å­˜é¢„è®¾</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '../api';
        let token = localStorage.getItem('admin_token');
        let currentType = '';
        let currentEditId = null;
        let formData = {};

        if (!token) window.location.href = 'login.html';
        const user = JSON.parse(localStorage.getItem('admin_user') || '{}');
        document.getElementById('currentUser').textContent = user.username || 'ç®¡ç†å‘˜';

        async function api(endpoint, options = {}) {
            const headers = { 'Content-Type': 'application/json', ...(token ? { 'Authorization': `Bearer ${token}` } : {}) };
            const response = await fetch(`${API_BASE}${endpoint}`, { ...options, headers });
            const data = await response.json();
            if (response.status === 401) { localStorage.clear(); window.location.href = 'login.html'; }
            return data;
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`; toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Tab switching
        document.querySelectorAll('.sidebar-item').forEach(item => {
            item.addEventListener('click', async () => {
                document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                item.classList.add('active');
                const tab = item.dataset.tab;
                document.getElementById(`${tab}-tab`).classList.add('active');
                await loadData(tab);
            });
        });

        async function loadData(tab) {
            switch(tab) {
                case 'presets': await loadPresets(); break;
                case 'dice-data': await loadActions(); await loadParts(); break;
                case 'pose-data': await loadPlaces(); await loadTimes(); await loadPoses(); break;
                case 'story-data': await loadMaleRoles(); await loadFemaleRoles(); await loadRelationships(); await loadInitiatives(); await loadBehaviors(); await loadStoryActions(); break;
                case 'task-data': await loadTasks(); break;
                case 'settings': // No data to load
                    break;
            }
        }

        // === Presets ===
        async function loadPresets() {
            const data = await api('/admin/presets');
            const container = document.getElementById('presetsList');

            // è°ƒè¯•ï¼šè¾“å‡º API è¿”å›æ•°æ®
            console.log('loadPresets API response:', data);

            if (!data.success) {
                container.innerHTML = `<div class="empty-state">åŠ è½½å¤±è´¥: ${data.message || 'æœªçŸ¥é”™è¯¯'}</div>`;
                return;
            }

            if (!data.data || !Array.isArray(data.data) || data.data.length === 0) {
                container.innerHTML = `<div class="empty-state">æš‚æ— é¢„è®¾ï¼Œç‚¹å‡»å³ä¸Šè§’"åˆ›å»ºé¢„è®¾"æŒ‰é’®æ·»åŠ </div>`;
                return;
            }

            let html = '';
            for (const preset of data.data) {
                const detail = await api(`/admin/presets/${preset.id}`);
                const roundsCount = detail.success ? (detail.data.rounds_data?.length || 0) : 0;
                const baseUrl = `${window.location.origin}${window.location.pathname.replace('admin/index.html', '')}`;

                html += `
                    <div class="preset-card">
                        <div class="preset-card-header">
                            <div>
                                <strong>${preset.name}</strong>
                                <span class="preset-code">${preset.share_code}</span>
                                <span style="margin-left: 8px; color: #666; font-size: 13px;">${roundsCount} è½®</span>
                            </div>
                            <div class="actions">
                                <button class="btn btn-secondary btn-sm" onclick="editPreset(${preset.id})">ç¼–è¾‘</button>
                                <button class="btn btn-danger btn-sm" onclick="deletePreset(${preset.id})">åˆ é™¤</button>
                            </div>
                        </div>
                        <div class="share-urls">
                            <div class="share-url-item">
                                <span>ğŸ² éª°å­ï¼š</span>
                                <a href="${baseUrl}touzi.html?code=${preset.share_code}" target="_blank">${baseUrl}touzi.html?code=${preset.share_code}</a>
                                <button class="btn btn-sm btn-secondary" onclick="copyUrl('${baseUrl}touzi.html?code=${preset.share_code}')">å¤åˆ¶</button>
                            </div>
                            <div class="share-url-item">
                                <span>ğŸ’‘ å§¿åŠ¿ï¼š</span>
                                <a href="${baseUrl}zishi.html?code=${preset.share_code}" target="_blank">${baseUrl}zishi.html?code=${preset.share_code}</a>
                                <button class="btn btn-sm btn-secondary" onclick="copyUrl('${baseUrl}zishi.html?code=${preset.share_code}')">å¤åˆ¶</button>
                            </div>
                            <div class="share-url-item">
                                <span>ğŸ“ ä»»åŠ¡ï¼š</span>
                                <a href="${baseUrl}suiji.html?code=${preset.share_code}" target="_blank">${baseUrl}suiji.html?code=${preset.share_code}</a>
                                <button class="btn btn-sm btn-secondary" onclick="copyUrl('${baseUrl}suiji.html?code=${preset.share_code}')">å¤åˆ¶</button>
                            </div>
                            <div class="share-url-item">
                                <span>ğŸ“– å‰§æƒ…ï¼š</span>
                                <a href="${baseUrl}story.html?code=${preset.share_code}" target="_blank">${baseUrl}story.html?code=${preset.share_code}</a>
                                <button class="btn btn-sm btn-secondary" onclick="copyUrl('${baseUrl}story.html?code=${preset.share_code}')">å¤åˆ¶</button>
                            </div>
                        </div>
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        function copyUrl(url) {
            navigator.clipboard.writeText(url).then(() => showToast('é“¾æ¥å·²å¤åˆ¶'));
        }

        // è½®æ•°è®¾ç½®å¼¹çª—
        function openRoundsSetupModal() {
            document.getElementById('setupRounds').value = 5;
            document.getElementById('roundsSetupModal').classList.add('active');
        }

        function closeRoundsSetupModal() {
            document.getElementById('roundsSetupModal').classList.remove('active');
        }

        async function confirmRoundsSetup() {
            const rounds = parseInt(document.getElementById('setupRounds').value) || 5;
            closeRoundsSetupModal();
            await openPresetModal(null, rounds);
        }

        async function openPresetModal(id = null, initialRounds = null) {
            currentEditId = id;

            // å¦‚æœæ˜¯æ–°å»ºä¸”æ²¡æœ‰æŒ‡å®šè½®æ•°ï¼Œå…ˆå¼¹å‡ºè½®æ•°è®¾ç½®
            if (!id && initialRounds === null) {
                openRoundsSetupModal();
                return;
            }

            const data = await api('/admin/presets/form-data');
            if (!data.success) { showToast('åŠ è½½æ•°æ®å¤±è´¥', 'error'); return; }
            formData = data.data;

            document.getElementById('presetModalTitle').textContent = (id ? 'ç¼–è¾‘' : 'åˆ›å»º') + 'é¢„è®¾';

            // åŸºæœ¬ä¿¡æ¯åŒºåŸŸ
            let formHtml = `
                <div class="form-row">
                    <div class="form-group"><label>é¢„è®¾åç§°</label><input type="text" id="presetName" placeholder="ä¾‹å¦‚ï¼šä»Šæ™šçš„æ¸¸æˆ"></div>
                    <div class="form-group" style="max-width: 150px;"><label>è½®æ•°</label><input type="number" id="presetRounds" value="${initialRounds || 5}" min="1" max="20" onchange="renderRoundEditors()"></div>
                    <div class="form-group" style="max-width: 150px;"><label>åˆ†äº«ç </label><input type="text" id="presetCode" placeholder="è‡ªåŠ¨ç”Ÿæˆ"></div>
                </div>
                <div id="roundEditors"></div>
            `;
            document.getElementById('presetModalBody').innerHTML = formHtml;

            if (id) {
                const preset = await api(`/admin/presets/${id}`);
                if (preset.success) {
                    document.getElementById('presetName').value = preset.data.name;
                    document.getElementById('presetCode').value = preset.data.share_code;
                    document.getElementById('presetRounds').value = preset.data.rounds || preset.data.rounds_data?.length || 5;
                    renderRoundEditors(preset.data.rounds_data);
                }
            } else {
                renderRoundEditors();
            }

            document.getElementById('presetModal').classList.add('active');
        }

        function closePresetModal() {
            document.getElementById('presetModal').classList.remove('active');
            currentEditId = null;
        }

        function renderRoundEditors(roundsData = null) {
            const count = parseInt(document.getElementById('presetRounds').value) || 5;
            const container = document.getElementById('roundEditors');

            // åˆ†åˆ—å¸ƒå±€ï¼šéª°å­ | å§¿åŠ¿ | ä»»åŠ¡
            let html = `
                <div style="margin: 16px 0 12px; font-size: 14px; color: #666;">è®¾ç½®æ¯è½®æ¸¸æˆçš„é¢„è®¾ç»“æœï¼ˆè¶…è¿‡è½®æ•°åè‡ªåŠ¨éšæœºï¼‰</div>
                <div class="round-columns">
                    <!-- éª°å­åˆ— -->
                    <div class="round-column dice">
                        <div class="column-title dice">ğŸ² éª°å­</div>
            `;

            // éª°å­åˆ—
            for (let i = 1; i <= count; i++) {
                const rd = roundsData?.[i - 1] || {};
                html += `
                    <div class="round-row multi-select">
                        <span class="round-label">ç¬¬${i}è½®</span>
                        <select id="action_${i}">
                            <option value="">åŠ¨ä½œ</option>
                            ${formData.actions?.map(a => `<option value="${a.id}" ${rd.dice_action_id == a.id ? 'selected' : ''}>${a.name}</option>`).join('')}
                        </select>
                        <select id="part_${i}">
                            <option value="">éƒ¨ä½</option>
                            ${formData.parts?.map(p => `<option value="${p.id}" ${rd.dice_part_id == p.id ? 'selected' : ''}>${p.name}</option>`).join('')}
                        </select>
                    </div>
                `;
            }

            html += `
                    </div>
                    <!-- å§¿åŠ¿åˆ— -->
                    <div class="round-column pose">
                        <div class="column-title pose">ğŸ’‘ å§¿åŠ¿</div>
            `;

            // å§¿åŠ¿åˆ—
            for (let i = 1; i <= count; i++) {
                const rd = roundsData?.[i - 1] || {};
                html += `
                    <div class="round-row multi-select">
                        <span class="round-label">ç¬¬${i}è½®</span>
                        <select id="pose_${i}">
                            <option value="">å§¿åŠ¿</option>
                            ${formData.poses?.map(p => `<option value="${p.id}" ${rd.pose_id == p.id ? 'selected' : ''}>${p.name}</option>`).join('')}
                        </select>
                        <select id="place_${i}">
                            <option value="">åœ°ç‚¹</option>
                            ${formData.places?.map(p => `<option value="${p.id}" ${rd.place_id == p.id ? 'selected' : ''}>${p.name}</option>`).join('')}
                        </select>
                        <select id="time_${i}">
                            <option value="">æ—¶é—´</option>
                            ${formData.times?.map(t => `<option value="${t.id}" ${rd.time_id == t.id ? 'selected' : ''}>${t.name}</option>`).join('')}
                        </select>
                    </div>
                `;
            }

            html += `
                    </div>
                    <!-- ä»»åŠ¡åˆ— -->
                    <div class="round-column task">
                        <div class="column-title task">ğŸ“ ä»»åŠ¡</div>
            `;

            // ä»»åŠ¡åˆ— - ä½¿ç”¨å¯æœç´¢ä¸‹æ‹‰æ¡†
            for (let i = 1; i <= count; i++) {
                const rd = roundsData?.[i - 1] || {};
                const selectedTask = formData.tasks?.find(t => t.id == rd.task_id);
                const displayText = selectedTask ? selectedTask.description.substring(0, 30) : '';

                html += `
                    <div class="round-row">
                        <span class="round-label">ç¬¬${i}è½®</span>
                        <div class="searchable-select" data-index="${i}" data-type="task">
                            <input type="text"
                                   id="task_${i}"
                                   data-id="${rd.task_id || ''}"
                                   value="${displayText.replace(/"/g, '&quot;')}"
                                   placeholder="æœç´¢ä»»åŠ¡..."
                                   onclick="toggleTaskDropdown(${i})"
                                   oninput="filterTasks(${i}, this.value)"
                                   onfocus="toggleTaskDropdown(${i})">
                            <div class="searchable-select-dropdown" id="task_dropdown_${i}">
                                <!-- åŠ¨æ€å¡«å……é€‰é¡¹ -->
                            </div>
                        </div>
                    </div>
                `;
            }

            html += `
                    </div>
                    <!-- å‰§æƒ…åˆ— -->
                    <div class="round-column story">
                        <div class="column-title story">ğŸ“– å‰§æƒ…</div>
            `;

            // å‰§æƒ…åˆ— - 6ä¸ªä¸‹æ‹‰æ¡†
            for (let i = 1; i <= count; i++) {
                const rd = roundsData?.[i - 1] || {};
                html += `
                    <div class="round-row" style="flex-wrap: wrap;">
                        <span class="round-label" style="width: 100%; margin-bottom: 4px;">ç¬¬${i}è½®</span>
                        <select id="maleRole_${i}" style="flex: 1; min-width: 60px; font-size: 11px; padding: 4px;">
                            <option value="">ç”·æ–¹</option>
                            ${formData.maleRoles?.map(m => `<option value="${m.id}" ${rd.story_male_role_id == m.id ? 'selected' : ''}>${m.name}</option>`).join('')}
                        </select>
                        <select id="femaleRole_${i}" style="flex: 1; min-width: 60px; font-size: 11px; padding: 4px;">
                            <option value="">å¥³æ–¹</option>
                            ${formData.femaleRoles?.map(f => `<option value="${f.id}" ${rd.story_female_role_id == f.id ? 'selected' : ''}>${f.name}</option>`).join('')}
                        </select>
                        <select id="relationship_${i}" style="flex: 1; min-width: 60px; font-size: 11px; padding: 4px;">
                            <option value="">å…³ç³»</option>
                            ${formData.relationships?.map(r => `<option value="${r.id}" ${rd.story_relationship_id == r.id ? 'selected' : ''}>${r.name}</option>`).join('')}
                        </select>
                        <select id="initiative_${i}" style="flex: 1; min-width: 60px; font-size: 11px; padding: 4px;">
                            <option value="">ä¸»åŠ¨</option>
                            ${formData.initiatives?.map(i => `<option value="${i.id}" ${rd.story_initiative_id == i.id ? 'selected' : ''}>${i.name}</option>`).join('')}
                        </select>
                        <select id="behavior_${i}" style="flex: 1; min-width: 60px; font-size: 11px; padding: 4px;">
                            <option value="">è¡Œä¸º</option>
                            ${formData.behaviors?.map(b => `<option value="${b.id}" ${rd.story_behavior_id == b.id ? 'selected' : ''}>${b.name}</option>`).join('')}
                        </select>
                        <select id="storyAction_${i}" style="flex: 1; min-width: 60px; font-size: 11px; padding: 4px;">
                            <option value="">åŠ¨ä½œ</option>
                            ${formData.storyActions?.map(s => `<option value="${s.id}" ${rd.story_action_id == s.id ? 'selected' : ''}>${s.name}</option>`).join('')}
                        </select>
                    </div>
                `;
            }

            html += `
                    </div>
                </div>
            `;

            container.innerHTML = html;

            // åˆå§‹åŒ–æ‰€æœ‰ä»»åŠ¡ä¸‹æ‹‰é€‰é¡¹
            for (let i = 1; i <= count; i++) {
                const rd = roundsData?.[i - 1] || {};
                initTaskDropdown(i, rd.task_id || '');
            }
        }

        // åˆå§‹åŒ–ä»»åŠ¡ä¸‹æ‹‰é€‰é¡¹
        function initTaskDropdown(index, selectedId) {
            const dropdown = document.getElementById(`task_dropdown_${index}`);
            if (!dropdown) return;
            renderTaskOptions(dropdown, formData.tasks || [], selectedId, index);
        }

        // æ¸²æŸ“ä»»åŠ¡é€‰é¡¹
        function renderTaskOptions(dropdown, tasks, selectedId, index) {
            if (!dropdown) return;
            if (tasks.length === 0) {
                dropdown.innerHTML = '<div class="searchable-select-option empty">æ— åŒ¹é…ç»“æœ</div>';
                return;
            }
            dropdown.innerHTML = tasks.map(t => {
                const displayText = t.description.length > 50
                    ? t.description.substring(0, 50) + '...'
                    : t.description;
                const shortText = t.description.substring(0, 30).replace(/'/g, "\\'").replace(/"/g, '\\"');
                return `<div class="searchable-select-option ${t.id == selectedId ? 'selected' : ''}"
                             onclick="selectTask(${index}, ${t.id}, '${shortText}')">
                            ${displayText}
                        </div>`;
            }).join('');
        }

        // åˆ‡æ¢ä¸‹æ‹‰æ¡†æ˜¾ç¤º
        function toggleTaskDropdown(index) {
            const dropdown = document.getElementById(`task_dropdown_${index}`);
            if (!dropdown) return;
            const allDropdowns = document.querySelectorAll('.searchable-select-dropdown');

            // å…³é—­å…¶ä»–ä¸‹æ‹‰æ¡†
            allDropdowns.forEach(d => {
                if (d.id !== `task_dropdown_${index}`) d.classList.remove('show');
            });

            // æ˜¾ç¤ºå½“å‰ä¸‹æ‹‰æ¡†å¹¶é‡ç½®é€‰é¡¹
            const isCurrentlyShown = dropdown.classList.contains('show');
            if (!isCurrentlyShown) {
                dropdown.classList.add('show');
                const input = document.getElementById(`task_${index}`);
                const selectedId = input?.dataset?.id || '';
                renderTaskOptions(dropdown, formData.tasks || [], selectedId, index);
            }
        }

        // è¿‡æ»¤ä»»åŠ¡
        function filterTasks(index, keyword) {
            const dropdown = document.getElementById(`task_dropdown_${index}`);
            const input = document.getElementById(`task_${index}`);
            if (!dropdown || !input) return;

            const selectedId = input.dataset?.id || '';
            const kw = keyword.toLowerCase();

            const filtered = (formData.tasks || []).filter(t =>
                t.description.toLowerCase().includes(kw)
            );
            renderTaskOptions(dropdown, filtered, selectedId, index);
            dropdown.classList.add('show');
        }

        // é€‰æ‹©ä»»åŠ¡
        function selectTask(index, taskId, taskName) {
            const input = document.getElementById(`task_${index}`);
            const dropdown = document.getElementById(`task_dropdown_${index}`);
            if (!input || !dropdown) return;

            input.value = taskName;
            input.dataset.id = taskId;
            dropdown.classList.remove('show');

            // é‡æ–°æ¸²æŸ“é€‰é¡¹ä»¥æ›´æ–°é€‰ä¸­çŠ¶æ€
            renderTaskOptions(dropdown, formData.tasks || [], taskId, index);
        }

        // ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰æ¡†
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.searchable-select')) {
                document.querySelectorAll('.searchable-select-dropdown').forEach(d => d.classList.remove('show'));
            }
        });

        async function generateRandomRounds() {
            const roundsInput = document.getElementById('presetRounds');
            const count = parseInt(roundsInput?.value) || 5;
            const data = await api('/admin/presets/generate', {
                method: 'POST',
                body: JSON.stringify({ rounds: count })
            });

            if (data.success) {
                renderRoundEditors(data.data.rounds);
                showToast('å·²éšæœºç”Ÿæˆæ‰€æœ‰æ¸¸æˆæ•°æ®');
            } else {
                showToast(data.message || 'ç”Ÿæˆå¤±è´¥', 'error');
            }
        }

        async function savePreset() {
            const name = document.getElementById('presetName').value.trim();
            const code = document.getElementById('presetCode').value.trim();
            const roundsInput = document.getElementById('presetRounds');
            const rounds = parseInt(roundsInput?.value) || 5;

            if (!name) { showToast('è¯·è¾“å…¥é¢„è®¾åç§°', 'error'); return; }

            const roundsData = [];
            for (let i = 1; i <= rounds; i++) {
                const actionEl = document.getElementById(`action_${i}`);
                const partEl = document.getElementById(`part_${i}`);
                const poseEl = document.getElementById(`pose_${i}`);
                const placeEl = document.getElementById(`place_${i}`);
                const timeEl = document.getElementById(`time_${i}`);
                const taskEl = document.getElementById(`task_${i}`);
                const maleRoleEl = document.getElementById(`maleRole_${i}`);
                const femaleRoleEl = document.getElementById(`femaleRole_${i}`);
                const relationshipEl = document.getElementById(`relationship_${i}`);
                const initiativeEl = document.getElementById(`initiative_${i}`);
                const behaviorEl = document.getElementById(`behavior_${i}`);
                const storyActionEl = document.getElementById(`storyAction_${i}`);

                const actionId = actionEl?.value;
                const partId = partEl?.value;
                const poseId = poseEl?.value;
                const placeId = placeEl?.value;
                const timeId = timeEl?.value;
                const taskId = taskEl?.dataset?.id;
                const maleRoleId = maleRoleEl?.value;
                const femaleRoleId = femaleRoleEl?.value;
                const relationshipId = relationshipEl?.value;
                const initiativeId = initiativeEl?.value;
                const behaviorId = behaviorEl?.value;
                const storyActionId = storyActionEl?.value;

                roundsData.push({
                    round_number: i,
                    dice_action_id: actionId ? parseInt(actionId) : null,
                    dice_part_id: partId ? parseInt(partId) : null,
                    pose_id: poseId ? parseInt(poseId) : null,
                    place_id: placeId ? parseInt(placeId) : null,
                    time_id: timeId ? parseInt(timeId) : null,
                    task_id: taskId ? parseInt(taskId) : null,
                    story_male_role_id: maleRoleId ? parseInt(maleRoleId) : null,
                    story_female_role_id: femaleRoleId ? parseInt(femaleRoleId) : null,
                    story_relationship_id: relationshipId ? parseInt(relationshipId) : null,
                    story_initiative_id: initiativeId ? parseInt(initiativeId) : null,
                    story_behavior_id: behaviorId ? parseInt(behaviorId) : null,
                    story_action_id: storyActionId ? parseInt(storyActionId) : null
                });
            }

            const body = { name, rounds, rounds_data: roundsData };
            if (code) body.share_code = code;

            const endpoint = currentEditId ? `/admin/presets/${currentEditId}` : '/admin/presets';
            const method = currentEditId ? 'PUT' : 'POST';

            const data = await api(endpoint, { method, body: JSON.stringify(body) });

            if (data.success) {
                showToast(currentEditId ? 'æ›´æ–°æˆåŠŸ' : 'åˆ›å»ºæˆåŠŸ');
                closePresetModal();
                loadPresets();
            } else {
                showToast(data.message || 'æ“ä½œå¤±è´¥', 'error');
            }
        }

        async function editPreset(id) {
            openPresetModal(id);
        }

        async function deletePreset(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ­¤é¢„è®¾å—ï¼Ÿ')) return;
            const data = await api(`/admin/presets/${id}`, { method: 'DELETE' });
            if (data.success) {
                showToast('åˆ é™¤æˆåŠŸ');
                loadPresets();
            } else {
                showToast('åˆ é™¤å¤±è´¥', 'error');
            }
        }

        // === CRUD Tables ===
        function renderTable(containerId, items, type) {
            const container = document.getElementById(containerId);
            if (!items || items.length === 0) { container.innerHTML = '<div class="loading">æš‚æ— æ•°æ®</div>'; return; }
            container.innerHTML = `
                <table><thead><tr><th>ID</th><th>åç§°</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead>
                <tbody>${items.map(item => `
                    <tr><td>${item.id}</td><td>${item.name || item.description?.substring(0, 50) || '-'}</td>
                    <td><span class="${item.is_active ? 'status-active' : 'status-inactive'}">${item.is_active ? 'å¯ç”¨' : 'ç¦ç”¨'}</span></td>
                    <td class="actions">
                        <button class="btn btn-secondary btn-sm" onclick="editItem('${type}', ${item.id})">ç¼–è¾‘</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteItem('${type}', ${item.id})">åˆ é™¤</button>
                    </td></tr>
                `).join('')}</tbody></table>
            `;
        }

        async function loadActions() { const d = await api('/admin/dice/actions'); if (d.success) renderTable('actionsTable', d.data, 'action'); }
        async function loadParts() { const d = await api('/admin/dice/parts'); if (d.success) renderTable('partsTable', d.data, 'part'); }
        async function loadPlaces() { const d = await api('/admin/poses/places'); if (d.success) renderTable('placesTable', d.data, 'place'); }
        async function loadTimes() { const d = await api('/admin/poses/times'); if (d.success) renderTable('timesTable', d.data, 'time'); }
        async function loadPoses() {
            const d = await api('/admin/poses');
            if (d.success) {
                document.getElementById('poseCount').textContent = d.data.length + ' ä¸ª';
                const container = document.getElementById('posesTable');
                container.innerHTML = `<table><thead><tr><th style="width:50px;">ID</th><th style="width:120px;">åç§°</th><th>æè¿°</th><th style="width:60px;">çŠ¶æ€</th><th style="width:140px;">æ“ä½œ</th></tr></thead><tbody>${d.data.map(p => `<tr><td>${p.id}</td><td>${p.name}</td><td><div style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${p.description || '-'}</div></td><td><span class="${p.is_active ? 'status-active' : 'status-inactive'}">${p.is_active ? 'å¯ç”¨' : 'ç¦ç”¨'}</span></td><td class="actions"><button class="btn btn-secondary btn-sm" onclick="editItem('pose', ${p.id})">ç¼–è¾‘</button><button class="btn btn-danger btn-sm" onclick="deleteItem('pose', ${p.id})">åˆ é™¤</button></td></tr>`).join('')}</tbody></table>`;
            }
        }
        async function loadTasks() {
            const d = await api('/admin/tasks');
            if (d.success) {
                const container = document.getElementById('tasksTable');
                container.innerHTML = `<table><thead><tr><th>ID</th><th>æè¿°</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr></thead><tbody>${d.data.map(t => `<tr><td>${t.id}</td><td>${t.description}</td><td><span class="${t.is_active ? 'status-active' : 'status-inactive'}">${t.is_active ? 'å¯ç”¨' : 'ç¦ç”¨'}</span></td><td class="actions"><button class="btn btn-secondary btn-sm" onclick="editItem('task', ${t.id})">ç¼–è¾‘</button><button class="btn btn-danger btn-sm" onclick="deleteItem('task', ${t.id})">åˆ é™¤</button></td></tr>`).join('')}</tbody></table>`;
            }
        }

        // Story data load functions
        async function loadMaleRoles() { const d = await api('/admin/stories/male-roles'); if (d.success) renderTable('maleRolesTable', d.data, 'story-male-roles'); }
        async function loadFemaleRoles() { const d = await api('/admin/stories/female-roles'); if (d.success) renderTable('femaleRolesTable', d.data, 'story-female-roles'); }
        async function loadRelationships() { const d = await api('/admin/stories/relationships'); if (d.success) renderTable('relationshipsTable', d.data, 'story-relationships'); }
        async function loadInitiatives() { const d = await api('/admin/stories/initiatives'); if (d.success) renderTable('initiativesTable', d.data, 'story-initiatives'); }
        async function loadBehaviors() { const d = await api('/admin/stories/behaviors'); if (d.success) renderTable('behaviorsTable', d.data, 'story-behaviors'); }
        async function loadStoryActions() { const d = await api('/admin/stories/actions'); if (d.success) renderTable('storyActionsTable', d.data, 'story-actions'); }

        function openModal(type, data = null) {
            currentType = type;
            currentEditId = data ? data.id : null;
            const titles = {
                action: 'åŠ¨ä½œ', part: 'éƒ¨ä½', place: 'åœ°ç‚¹', time: 'æ—¶é—´', pose: 'å§¿åŠ¿', task: 'ä»»åŠ¡',
                'story-male-roles': 'ç”·æ–¹èº«ä»½',
                'story-female-roles': 'å¥³æ–¹èº«ä»½',
                'story-relationships': 'ä¸¤äººå…³ç³»',
                'story-initiatives': 'ä¸»åŠ¨æƒ',
                'story-behaviors': 'è¡Œä¸º',
                'story-actions': 'åŠ¨ä½œ'
            };
            document.getElementById('modalTitle').textContent = (currentEditId ? 'ç¼–è¾‘' : 'æ·»åŠ ') + titles[type];

            let formHtml = '';
            if (type === 'pose') {
                formHtml = `
                    <div class="form-group"><label>åç§°</label><input type="text" id="itemName" value="${data?.name || ''}" required></div>
                    <div class="form-group"><label>å›¾ç‰‡è·¯å¾„</label><input type="text" id="itemImage" value="${data?.image_path || ''}"></div>
                    <div class="form-group"><label>æè¿°</label><textarea id="itemDesc">${data?.description || ''}</textarea></div>
                    <div class="form-group"><label>æ’åº</label><input type="number" id="itemSort" value="${data?.sort_order || 0}"></div>
                    <div class="form-group checkbox-group"><input type="checkbox" id="itemActive" ${data?.is_active !== 0 ? 'checked' : ''}><label>å¯ç”¨</label></div>
                `;
            } else if (type === 'task') {
                formHtml = `
                    <div class="form-group"><label>æè¿°</label><textarea id="itemDesc" required>${data?.description || ''}</textarea></div>
                    <div class="form-group checkbox-group"><input type="checkbox" id="itemActive" ${data?.is_active !== 0 ? 'checked' : ''}><label>å¯ç”¨</label></div>
                `;
            } else {
                // All other types including story types
                formHtml = `
                    <div class="form-group"><label>åç§°</label><input type="text" id="itemName" value="${data?.name || ''}" required></div>
                    <div class="form-group"><label>æ’åº</label><input type="number" id="itemSort" value="${data?.sort_order || 0}"></div>
                    <div class="form-group checkbox-group"><input type="checkbox" id="itemActive" ${data?.is_active !== 0 ? 'checked' : ''}><label>å¯ç”¨</label></div>
                `;
            }
            document.getElementById('modalBody').innerHTML = formHtml;
            document.getElementById('modal').classList.add('active');
        }

        function closeModal() { document.getElementById('modal').classList.remove('active'); currentType = ''; currentEditId = null; }

        async function editItem(type, id) {
            const endpoints = {
                action: '/admin/dice/actions', part: '/admin/dice/parts',
                place: '/admin/poses/places', time: '/admin/poses/times',
                pose: '/admin/poses', task: '/admin/tasks',
                'story-male-roles': '/admin/stories/male-roles',
                'story-female-roles': '/admin/stories/female-roles',
                'story-relationships': '/admin/stories/relationships',
                'story-initiatives': '/admin/stories/initiatives',
                'story-behaviors': '/admin/stories/behaviors',
                'story-actions': '/admin/stories/actions'
            };
            const d = await api(`${endpoints[type]}/${id}`);
            if (d.success) openModal(type, d.data);
        }

        async function saveItem() {
            const endpoints = {
                action: '/admin/dice/actions', part: '/admin/dice/parts',
                place: '/admin/poses/places', time: '/admin/poses/times',
                pose: '/admin/poses', task: '/admin/tasks',
                'story-male-roles': '/admin/stories/male-roles',
                'story-female-roles': '/admin/stories/female-roles',
                'story-relationships': '/admin/stories/relationships',
                'story-initiatives': '/admin/stories/initiatives',
                'story-behaviors': '/admin/stories/behaviors',
                'story-actions': '/admin/stories/actions'
            };
            let body = { is_active: document.getElementById('itemActive')?.checked ? 1 : 0 };

            if (currentType === 'task') {
                body.description = document.getElementById('itemDesc').value;
            } else if (currentType === 'pose') {
                body = { ...body, name: document.getElementById('itemName').value, image_path: document.getElementById('itemImage').value, description: document.getElementById('itemDesc').value, sort_order: parseInt(document.getElementById('itemSort').value) || 0 };
            } else {
                body = { ...body, name: document.getElementById('itemName').value, sort_order: parseInt(document.getElementById('itemSort').value) || 0 };
            }

            const endpoint = currentEditId ? `${endpoints[currentType]}/${currentEditId}` : endpoints[currentType];
            const data = await api(endpoint, { method: currentEditId ? 'PUT' : 'POST', body: JSON.stringify(body) });

            if (data.success) { showToast(currentEditId ? 'æ›´æ–°æˆåŠŸ' : 'æ·»åŠ æˆåŠŸ'); closeModal(); loadData(document.querySelector('.sidebar-item.active').dataset.tab); }
            else showToast(data.message || 'æ“ä½œå¤±è´¥', 'error');
        }

        async function deleteItem(type, id) {
            if (!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) return;
            const endpoints = {
                action: '/admin/dice/actions', part: '/admin/dice/parts',
                place: '/admin/poses/places', time: '/admin/poses/times',
                pose: '/admin/poses', task: '/admin/tasks',
                'story-male-roles': '/admin/stories/male-roles',
                'story-female-roles': '/admin/stories/female-roles',
                'story-relationships': '/admin/stories/relationships',
                'story-initiatives': '/admin/stories/initiatives',
                'story-behaviors': '/admin/stories/behaviors',
                'story-actions': '/admin/stories/actions'
            };
            const data = await api(`${endpoints[type]}/${id}`, { method: 'DELETE' });
            if (data.success) { showToast('åˆ é™¤æˆåŠŸ'); loadData(document.querySelector('.sidebar-item.active').dataset.tab); }
            else showToast('åˆ é™¤å¤±è´¥', 'error');
        }

        async function logout() {
            await api('/auth/logout', { method: 'POST' });
            localStorage.clear();
            window.location.href = 'login.html';
        }

        async function changePassword(e) {
            e.preventDefault();
            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword !== confirmPassword) {
                showToast('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´', 'error');
                return;
            }

            const data = await api('/auth/change-password', {
                method: 'POST',
                body: JSON.stringify({ old_password: oldPassword, new_password: newPassword })
            });

            if (data.success) {
                showToast('å¯†ç ä¿®æ”¹æˆåŠŸï¼Œè¯·é‡æ–°ç™»å½•');
                setTimeout(() => logout(), 1500);
            } else {
                showToast(data.message || 'ä¿®æ”¹å¤±è´¥', 'error');
            }
        }

        // Initial load
        loadPresets();
    </script>
</body>
</html>
