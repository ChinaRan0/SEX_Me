<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æƒ…è¶£éª°å­</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #fff;
            overflow-x: hidden;
        }

        .container {
            max-width: 480px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            text-align: center;
            padding: 20px 0;
        }

        header h1 {
            font-size: 28px;
            font-weight: 600;
            background: linear-gradient(90deg, #ff6b6b, #ff8e8e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        header p {
            color: #888;
            font-size: 14px;
        }

        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            z-index: 100;
            transition: all 0.3s ease;
        }

        .back-btn:active {
            transform: scale(0.9);
            background: rgba(255, 255, 255, 0.2);
        }

        /* æ¨¡å¼åˆ‡æ¢ */
        .mode-switch {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .mode-btn {
            padding: 10px 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
            border-radius: 25px;
            color: #888;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mode-btn.active {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%);
            border-color: transparent;
            color: #fff;
        }

        .dice-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 50px;
            padding: 20px 0;
        }

        .dice-container.hidden {
            display: none;
        }

        .dice-section {
            width: 100%;
        }

        .dice-label {
            text-align: center;
            font-size: 14px;
            color: #888;
            margin-bottom: 15px;
        }

        .dice-viewport {
            position: relative;
            width: 100%;
            height: 100px;
            overflow: hidden;
            border-radius: 16px;
            background: rgba(0, 0, 0, 0.3);
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.5);
        }

        /* å·¦å³æ¸å˜é®ç½© */
        .dice-viewport::before,
        .dice-viewport::after {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            width: 50px;
            pointer-events: none;
            z-index: 10;
        }

        .dice-viewport::before {
            left: 0;
            background: linear-gradient(to right, rgba(0,0,0,0.7), transparent);
        }

        .dice-viewport::after {
            right: 0;
            background: linear-gradient(to left, rgba(0,0,0,0.7), transparent);
        }

        /* ä¸­é—´æŒ‡ç¤ºå™¨ */
        .dice-viewport .indicator {
            position: absolute;
            left: 50%;
            top: 5px;
            bottom: 5px;
            width: 100px;
            transform: translateX(-50%);
            border: 2px solid #ff6b6b;
            border-radius: 12px;
            pointer-events: none;
            z-index: 5;
            box-shadow: 0 0 20px rgba(255, 107, 107, 0.4);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .dice-viewport.stopped .indicator {
            opacity: 1;
        }

        .dice-track {
            display: flex;
            flex-direction: row;
            height: 100%;
            align-items: center;
            will-change: transform;
        }

        .dice-item {
            flex-shrink: 0;
            width: 90px;
            height: 90px;
            margin: 0 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 600;
            color: #ccc;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .dice-item.selected {
            background: linear-gradient(145deg, #ff6b6b, #ff8e8e);
            color: #fff;
            box-shadow: 0 0 25px rgba(255, 107, 107, 0.6);
        }

        /* å‰æˆæ¨¡å¼å®¹å™¨ */
        .foreplay-container {
            flex: 1;
            display: none;
            flex-direction: column;
            justify-content: center;
            padding: 20px 0;
        }

        .foreplay-container.show {
            display: flex;
        }

        .foreplay-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .foreplay-item {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(255, 255, 255, 0.06);
            border-radius: 16px;
            padding: 15px 20px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.4s ease;
        }

        .foreplay-item.show {
            opacity: 1;
            transform: translateY(0);
        }

        .foreplay-item.rolling {
            animation: foreplayRoll 0.1s ease infinite;
        }

        @keyframes foreplayRoll {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .foreplay-num {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 700;
            flex-shrink: 0;
        }

        .foreplay-text {
            flex: 1;
            font-size: 18px;
            font-weight: 600;
            color: #fff;
        }

        .result-display {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.4s ease;
        }

        .result-display.show {
            opacity: 1;
            transform: translateY(0);
        }

        .result-text {
            font-size: 36px;
            font-weight: 700;
            background: linear-gradient(90deg, #ff6b6b, #ffa07a);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .result-hint {
            font-size: 14px;
            color: #888;
            margin-top: 8px;
        }

        .btn-roll {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%);
            border: none;
            border-radius: 50px;
            padding: 18px 50px;
            font-size: 18px;
            font-weight: 600;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(255, 107, 107, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            max-width: 280px;
            margin: 20px auto 0;
        }

        .btn-roll:active {
            transform: scale(0.95);
        }

        .btn-roll.rolling {
            opacity: 0.7;
            pointer-events: none;
        }

        .btn-icon {
            font-size: 20px;
        }

        .safe-area-bottom {
            height: env(safe-area-inset-bottom, 20px);
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-btn">â€¹</a>
    <div class="container">
        <header>
            <h1>æƒ…è¶£éª°å­</h1>
            <p>æ·éª°å­ï¼Œå†³å®šä»Šæ™šçš„ç©æ³•</p>
        </header>

        <!-- æ¨¡å¼åˆ‡æ¢ -->
        <div class="mode-switch">
            <button class="mode-btn active" id="modeSingle" onclick="switchMode('single')">å•æ¬¡æ·éª°</button>
            <button class="mode-btn" id="modeForeplay" onclick="switchMode('foreplay')">éšæœºå‰æˆ</button>
        </div>

        <!-- å•æ¬¡æ·éª°æ¨¡å¼ -->
        <div class="dice-container" id="diceContainer">
            <!-- åŠ¨ä½œéª°å­ -->
            <div class="dice-section">
                <div class="dice-label">ğŸ² åŠ¨ä½œ</div>
                <div class="dice-viewport" id="actionViewport">
                    <div class="indicator"></div>
                    <div class="dice-track" id="actionTrack"></div>
                </div>
            </div>

            <!-- éƒ¨ä½éª°å­ -->
            <div class="dice-section">
                <div class="dice-label">ğŸ¯ éƒ¨ä½</div>
                <div class="dice-viewport" id="partViewport">
                    <div class="indicator"></div>
                    <div class="dice-track" id="partTrack"></div>
                </div>
            </div>

            <!-- ç»“æœæ˜¾ç¤º -->
            <div class="result-display" id="resultDisplay">
                <div class="result-text" id="resultText"></div>
                <div class="result-hint">å°½æƒ…äº«å—å§~</div>
            </div>
        </div>

        <!-- éšæœºå‰æˆæ¨¡å¼ -->
        <div class="foreplay-container" id="foreplayContainer">
            <div class="foreplay-list" id="foreplayList">
                <div class="foreplay-item" data-index="0">
                    <div class="foreplay-num">1</div>
                    <div class="foreplay-text">ç­‰å¾…æŠ½å–...</div>
                </div>
                <div class="foreplay-item" data-index="1">
                    <div class="foreplay-num">2</div>
                    <div class="foreplay-text">ç­‰å¾…æŠ½å–...</div>
                </div>
                <div class="foreplay-item" data-index="2">
                    <div class="foreplay-num">3</div>
                    <div class="foreplay-text">ç­‰å¾…æŠ½å–...</div>
                </div>
                <div class="foreplay-item" data-index="3">
                    <div class="foreplay-num">4</div>
                    <div class="foreplay-text">ç­‰å¾…æŠ½å–...</div>
                </div>
                <div class="foreplay-item" data-index="4">
                    <div class="foreplay-num">5</div>
                    <div class="foreplay-text">ç­‰å¾…æŠ½å–...</div>
                </div>
            </div>
        </div>

        <button class="btn-roll" id="btnRoll" onclick="startRoll()">
            <span class="btn-icon">ğŸ²</span>
            <span id="btnText">æ·éª°å­</span>
        </button>

        <div class="safe-area-bottom"></div>
    </div>

    <script>
        const API_BASE = 'api';
        const urlParams = new URLSearchParams(window.location.search);
        const presetCode = urlParams.get('code');

        let actions = [];
        let parts = [];
        let preset = null;
        let currentRound = 0;
        let isRolling = false;
        let currentMode = 'single';
        const ITEM_WIDTH = 100;

        // è®¾ç½®è¿”å›æŒ‰é’®è¡Œä¸º
        function setupBackButton() {
            const backBtn = document.querySelector('.back-btn');
            if (!backBtn) return;

            backBtn.addEventListener('click', (e) => {
                e.preventDefault();
                // ä¼˜å…ˆè¿”å›ä¸Šä¸€é¡µ
                if (window.history.length > 1) {
                    window.history.back();
                } else if (presetCode) {
                    // æ— å†å²æ—¶ï¼Œè¿”å›å¸¦ code çš„é¦–é¡µ
                    window.location.href = `index.html?code=${presetCode}`;
                } else {
                    window.location.href = 'index.html';
                }
            });
        }

        // åŠ è½½æ•°æ®
        async function loadData() {
            // å…ˆåŠ è½½åŸºç¡€æ•°æ®
            try {
                const response = await fetch(`${API_BASE}/dice`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const result = await response.json();
                if (result.success) {
                    actions = result.data.actions;
                    parts = result.data.parts;
                } else {
                    throw new Error(result.message);
                }
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                actions = ["æŒ‰æ‘©", "äº²å»", "è½»å’¬", "èˆ”èˆ", "æŠšæ‘¸", "å¹æ°”", "æŒ ç—’", "å†°æ•·"];
                parts = ["è€³æœµ", "è„–é¢ˆ", "è‚©è†€", "èƒ¸å£", "åèƒŒ", "è…°éƒ¨", "è‡€éƒ¨", "å¤§è…¿"];
            }

            // å¦‚æœæœ‰é¢„è®¾ç ï¼Œé™é»˜åŠ è½½é¢„è®¾ï¼ˆä¸æ”¹å˜ç•Œé¢ï¼‰
            if (presetCode) {
                try {
                    const response = await fetch(`${API_BASE}/preset/${presetCode}`);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    const data = await response.json();
                    if (data.success) {
                        preset = data.data;
                        // ä» localStorage æ¢å¤å½“å‰è½®æ¬¡
                        const savedRound = localStorage.getItem(`preset_round_${presetCode}_dice`);
                        currentRound = savedRound ? parseInt(savedRound) : 0;
                        // é¢„è®¾æ¨¡å¼é»˜è®¤ä½¿ç”¨å•æ¬¡æŠ•æ·æ¨¡å¼
                        currentMode = 'single';
                        document.getElementById('modeSingle').classList.add('active');
                        document.getElementById('modeForeplay').classList.remove('active');
                        document.getElementById('diceContainer').classList.remove('hidden');
                        document.getElementById('foreplayContainer').classList.remove('show');
                        document.getElementById('btnText').textContent = 'æ·éª°å­';
                    }
                } catch (e) {
                    console.error('åŠ è½½é¢„è®¾å¤±è´¥:', e);
                }
            }
            // åˆ é™¤æ—§çš„æŒ‰ç±»å‹åˆ†å¼€çš„é¢„è®¾æ•°æ®ï¼Œä½¿ç”¨ç»Ÿä¸€çš„ rounds_data

            requestAnimationFrame(() => {
                initDice();
            });
        }

        // åˆå§‹åŒ–éª°å­
        function initDice() {
            createDiceTrack('actionTrack', actions);
            createDiceTrack('partTrack', parts);
        }

        // åˆ›å»ºéª°å­è½¨é“
        function createDiceTrack(trackId, items) {
            const track = document.getElementById(trackId);
            const viewport = track.parentElement;
            const viewportWidth = viewport.offsetWidth || window.innerWidth - 40;
            const repeatCount = 30;
            let html = '';

            for (let i = 0; i < repeatCount; i++) {
                items.forEach((item, idx) => {
                    html += `<div class="dice-item">${item}</div>`;
                });
            }

            track.innerHTML = html;

            const middleGroup = Math.floor(repeatCount / 2);
            const targetItemIndex = middleGroup * items.length;
            const offset = viewportWidth / 2 - (targetItemIndex * ITEM_WIDTH + ITEM_WIDTH / 2);
            track.dataset.baseOffset = offset;
            track.style.transform = `translateX(${offset}px)`;
        }

        // è·å–å½“å‰çš„ translateX å€¼
        function getTranslateX(element) {
            const style = window.getComputedStyle(element);
            const matrix = style.transform;
            if (matrix === 'none') return 0;
            const values = matrix.match(/matrix.*\((.+)\)/)[1].split(', ');
            return parseFloat(values[4]) || 0;
        }

        // åˆ‡æ¢æ¨¡å¼
        function switchMode(mode) {
            currentMode = mode;
            document.getElementById('modeSingle').classList.toggle('active', mode === 'single');
            document.getElementById('modeForeplay').classList.toggle('active', mode === 'foreplay');
            document.getElementById('diceContainer').classList.toggle('hidden', mode === 'foreplay');
            document.getElementById('foreplayContainer').classList.toggle('show', mode === 'foreplay');

            const btnText = document.getElementById('btnText');
            btnText.textContent = mode === 'single' ? 'æ·éª°å­' : 'å¼€å§‹æŠ½å–';

            // é‡ç½®çŠ¶æ€
            resetState();
        }

        // é‡ç½®çŠ¶æ€
        function resetState() {
            document.getElementById('resultDisplay').classList.remove('show');
            document.getElementById('actionViewport').classList.remove('stopped');
            document.getElementById('partViewport').classList.remove('stopped');
            document.querySelectorAll('.dice-item.selected').forEach(el => {
                el.classList.remove('selected');
            });

            // é‡ç½®å‰æˆåˆ—è¡¨
            document.querySelectorAll('.foreplay-item').forEach(item => {
                item.classList.remove('show', 'rolling');
                item.querySelector('.foreplay-text').textContent = 'ç­‰å¾…æŠ½å–...';
            });
        }

        // å¼€å§‹æŠ½å–
        function startRoll() {
            if (isRolling) return;

            if (currentMode === 'single') {
                rollDice();
            } else {
                rollForeplay();
            }
        }

        // æ·éª°å­ï¼ˆå•æ¬¡æ¨¡å¼ï¼‰
        function rollDice() {
            if (isRolling) return;

            isRolling = true;
            const btn = document.getElementById('btnRoll');
            const btnText = document.getElementById('btnText');
            btn.classList.add('rolling');
            btnText.textContent = 'æ»šåŠ¨ä¸­...';

            resetState();

            const actionTrack = document.getElementById('actionTrack');
            const partTrack = document.getElementById('partTrack');
            const actionViewport = document.getElementById('actionViewport');
            const partViewport = document.getElementById('partViewport');

            // é¢„è®¾æ¨¡å¼ä½¿ç”¨é¢„è®¾æ•°æ®ï¼Œå¦åˆ™éšæœº
            let actionIndex, partIndex;
            if (preset && preset.rounds_data && currentRound < preset.rounds_data.length) {
                // ä½¿ç”¨é¢„è®¾æ•°æ®
                const round = preset.rounds_data[currentRound];
                actionIndex = actions.indexOf(round.dice_action_name);
                partIndex = parts.indexOf(round.dice_part_name);
                // å¦‚æœæ‰¾ä¸åˆ°ï¼Œéšæœºé€‰
                if (actionIndex < 0) actionIndex = Math.floor(Math.random() * actions.length);
                if (partIndex < 0) partIndex = Math.floor(Math.random() * parts.length);
            } else {
                // è¶…è½®éšæœº
                actionIndex = Math.floor(Math.random() * actions.length);
                partIndex = Math.floor(Math.random() * parts.length);
            }

            const duration = 2000 + Math.random() * 1000;
            const viewportWidth = actionViewport.offsetWidth || window.innerWidth - 40;

            const actionSpins = Math.floor(Math.random() * 4) + 3;
            const partSpins = Math.floor(Math.random() * 4) + 3;

            // è®¡ç®—ç›®æ ‡å…ƒç´ ç´¢å¼•ï¼Œä½¿å…¶å±…ä¸­
            const actionTargetIdx = actionSpins * actions.length + actionIndex;
            const partTargetIdx = partSpins * parts.length + partIndex;

            // ç›´æ¥è®¡ç®—è®©ç›®æ ‡å…ƒç´ å±…ä¸­çš„ translateX
            const actionTargetX = viewportWidth / 2 - (actionTargetIdx * ITEM_WIDTH + ITEM_WIDTH / 2);
            const partTargetX = viewportWidth / 2 - (partTargetIdx * ITEM_WIDTH + ITEM_WIDTH / 2);

            const actionStartX = getTranslateX(actionTrack);
            const partStartX = getTranslateX(partTrack);

            const startTime = performance.now();

            function animate(currentTime) {
                const elapsed = currentTime - startTime;
                let progress = Math.min(elapsed / duration, 1);
                const easeOut = 1 - Math.pow(1 - progress, 4);

                const actionX = actionStartX + (actionTargetX - actionStartX) * easeOut;
                const partX = partStartX + (partTargetX - partStartX) * easeOut;

                actionTrack.style.transform = `translateX(${actionX}px)`;
                partTrack.style.transform = `translateX(${partX}px)`;

                if (progress < 1) {
                    requestAnimationFrame(animate);
                } else {
                    actionTrack.style.transform = `translateX(${actionTargetX}px)`;
                    partTrack.style.transform = `translateX(${partTargetX}px)`;
                    finishRoll(actionIndex, partIndex, actionTargetX, partTargetX, viewportWidth);
                }
            }

            requestAnimationFrame(animate);
        }

        // å®Œæˆæ·éª°
        function finishRoll(actionIndex, partIndex, actionX, partX, viewportWidth) {
            const actionViewport = document.getElementById('actionViewport');
            const partViewport = document.getElementById('partViewport');

            actionViewport.classList.add('stopped');
            partViewport.classList.add('stopped');

            const actionTrack = document.getElementById('actionTrack');
            const partTrack = document.getElementById('partTrack');

            const centerOffset = viewportWidth / 2;
            const actionCenterIdx = Math.round((centerOffset - ITEM_WIDTH / 2 - actionX) / ITEM_WIDTH);
            const partCenterIdx = Math.round((centerOffset - ITEM_WIDTH / 2 - partX) / ITEM_WIDTH);

            const actionItems = actionTrack.querySelectorAll('.dice-item');
            const partItems = partTrack.querySelectorAll('.dice-item');

            if (actionItems[actionCenterIdx]) {
                actionItems[actionCenterIdx].classList.add('selected');
            }
            if (partItems[partCenterIdx]) {
                partItems[partCenterIdx].classList.add('selected');
            }

            // ä½¿ç”¨å–æ¨¡è¿ç®—ä» DOM ç´¢å¼•è·å–å®é™…æ•°æ®ç´¢å¼•
            const realActionIdx = actionCenterIdx % actions.length;
            const realPartIdx = partCenterIdx % parts.length;

            const resultDisplay = document.getElementById('resultDisplay');
            const resultText = document.getElementById('resultText');
            resultText.textContent = `${actions[realActionIdx]}${parts[realPartIdx]}`;
            resultDisplay.classList.add('show');

            const btn = document.getElementById('btnRoll');
            const btnText = document.getElementById('btnText');
            btn.classList.remove('rolling');
            btnText.textContent = 'å†æ·ä¸€æ¬¡';

            if (navigator.vibrate) {
                navigator.vibrate([50, 50, 100]);
            }

            // é¢„è®¾æ¨¡å¼ä¸‹ï¼Œä¿å­˜è½®æ¬¡çŠ¶æ€ï¼ˆå•æ¬¡æ¨¡å¼ä¸€æ¬¡ä¸€è½®ï¼‰
            if (presetCode && preset && preset.rounds_data && currentRound < preset.rounds_data.length) {
                currentRound++;
                localStorage.setItem(`preset_round_${presetCode}_dice`, currentRound.toString());
            }

            isRolling = false;
        }

        // éšæœºå‰æˆæ¨¡å¼
        function rollForeplay() {
            if (isRolling) return;

            isRolling = true;
            const btn = document.getElementById('btnRoll');
            const btnText = document.getElementById('btnText');
            btn.classList.add('rolling');
            btnText.textContent = 'æŠ½å–ä¸­...';

            // é‡ç½®
            document.querySelectorAll('.foreplay-item').forEach(item => {
                item.classList.remove('show', 'rolling');
                item.querySelector('.foreplay-text').textContent = 'ç­‰å¾…æŠ½å–...';
            });

            // ç”Ÿæˆ5ä¸ªç»“æœ
            const results = [];
            for (let i = 0; i < 5; i++) {
                const roundIndex = currentRound + i;
                if (preset && preset.rounds_data && preset.rounds_data[roundIndex]) {
                    // é™é»˜ä½¿ç”¨é¢„è®¾ç»“æœ
                    results.push({
                        action: preset.rounds_data[roundIndex].dice_action_name || actions[Math.floor(Math.random() * actions.length)],
                        part: preset.rounds_data[roundIndex].dice_part_name || parts[Math.floor(Math.random() * parts.length)]
                    });
                } else {
                    // éšæœºç»“æœï¼ˆè¶…è½®éšæœºï¼‰
                    const actionIdx = Math.floor(Math.random() * actions.length);
                    const partIdx = Math.floor(Math.random() * parts.length);
                    results.push({
                        action: actions[actionIdx],
                        part: parts[partIdx]
                    });
                }
            }

            // é¢„è®¾æ¨¡å¼ä¸‹ï¼ŒæŠ½å–å®Œæˆåä¿å­˜è½®æ¬¡ï¼ˆå‰æˆæ¨¡å¼ä¸€æ¬¡æŠ½å–5ä¸ªï¼‰
            if (presetCode && preset) {
                currentRound += 5;
                localStorage.setItem(`preset_round_${presetCode}_dice`, currentRound.toString());
            }

            // ä¾æ¬¡æ˜¾ç¤ºæ¯ä¸ªç»“æœï¼ˆå¸¦æ»šåŠ¨åŠ¨ç”»ï¼‰
            let currentIndex = 0;

            function showNextResult() {
                if (currentIndex >= 5) {
                    // å…¨éƒ¨å®Œæˆ
                    btn.classList.remove('rolling');
                    btnText.textContent = 'å†æŠ½ä¸€æ¬¡';
                    isRolling = false;

                    if (navigator.vibrate) {
                        navigator.vibrate([100, 50, 100, 50, 200]);
                    }
                    return;
                }

                const item = document.querySelector(`.foreplay-item[data-index="${currentIndex}"]`);
                const textEl = item.querySelector('.foreplay-text');
                item.classList.add('show', 'rolling');

                // æ»šåŠ¨åŠ¨ç”»
                let rollCount = 0;
                const maxRolls = 8 + currentIndex * 2; // è¶Šåé¢æ»šåŠ¨è¶Šä¹…
                const rollInterval = setInterval(() => {
                    const randomAction = actions[Math.floor(Math.random() * actions.length)];
                    const randomPart = parts[Math.floor(Math.random() * parts.length)];
                    textEl.textContent = `${randomAction}${randomPart}`;
                    rollCount++;

                    if (rollCount >= maxRolls) {
                        clearInterval(rollInterval);
                        // æ˜¾ç¤ºæœ€ç»ˆç»“æœ
                        textEl.textContent = `${results[currentIndex].action}${results[currentIndex].part}`;
                        item.classList.remove('rolling');

                        if (navigator.vibrate) {
                            navigator.vibrate(50);
                        }

                        currentIndex++;
                        setTimeout(showNextResult, 300);
                    }
                }, 80);
            }

            showNextResult();
        }

        // é¡µé¢åŠ è½½
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            setupBackButton();
        });
    </script>
</body>
</html>
